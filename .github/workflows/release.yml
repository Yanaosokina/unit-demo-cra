name: Release

on:
    push:
        tags: 
         - 'v[0-9]+'

jobs:
    tests:
        uses: ./.github/workflows/main.yml
    
    release:
        needs: tests
        runs-on: ubuntu-latest
        permissions:
            issues: write
            contents: read
        steps:
            - uses: actions/checkout@v3
              with:
                fetch-depth: 0
            - name: Get information
              id: tags
              run: |
                currentTag=${{ github.ref_name }}
                previousTag=$(git --no-pager tag --sort=creatordate --merged ${{ github.ref_name }} | tail -2 | head -1)
                echo "currentTag=${currentTag}" >> $GITHUB_OUTPUT
                echo "previousTag=${previousTag}" >> $GITHUB_OUTPUT
                echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
                echo "date=$(date +'%d.%m.%Y %H:%M:%S')" >> $GITHUB_OUTPUT

            - name: Build Changelog
              id: build_changelog
              uses: ardalanamini/auto-changelog@v4
              with:
                  github-token: ${{ github.token }}
                  commit-types: |
                    build: 🚀 Build System & Dependencies
                    ci:  Continuous Integrations
                    docs: 📖 Documentation
                    feat: 🐛 New Features
                    fix: 🐞 Bug Fixes
                    perf: 🔥 Performance Improvements
                    refactor: 🔨 Refactors
                    revert: 🔙 Reverts
                    style: 🔧 Code Style
                    test: 🧪 Tests
                  default-commit-type: 📂 Other Changes
                  mention-authors: true
                  mention-new-contributors: false
                  include-compare-link: true
                  include-pr-links: true
                  include-commit-links: true
                  semver: false
                  use-github-autolink: true

            - name: Create/update issue
              id: create_issue
              uses: JasonEtco/create-an-issue@v2
              env:
                VESION: ${{ steps.tags.outputs.currentTag }}
                AUTHOR: ${{ steps.tags.outputs.author }}
                DATE: ${{ steps.tags.outputs.date }}
                CHANGELOG: ${{ steps.build_changelog.outputs.changelog }}
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with: 
                filename: .github/ISSUE.mb
                update_existing: true
                search_existing: all
            
            - name: Comment issue
              uses: peter-evans/create-or-update-comment@v3
              with:
                issue-number: ${{ steps.create_issue.outputs.issue-number }}
                body: |
                    ## 👀 Release
                    ${{github.server_url}}/${{ github.repository }}
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        outputs: 
          issue-number: ${{ steps.create_issue.outputs.issue-number }}  

    build-and-deploy: 
        needs: release
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                token: ${{ secrets.GITHUB_TOKEN }}

            - name: Creating release
              run: |
                git chekout -b release-${{github.ref_name}}
                git push -u origin release-${{ github.ref_name }}

            - name: Node install
              uses: actions/setup-node@v3
              with: 
                node-version: 16.13.0

            - name: Install & Build
              run: |
                npm ci
                PUBLIC_URL="/unit-demo-cra" npm run build

            - name: Deploy
              uses: JamesIves/github-pages-deploy-action@v4 
              with:
                folder: build\

        outputs:
          issueNumber: ${{ needs.release.outputs.issue-number }}

    close-issue:
      permissions:
        contents: read
        issues: write

      needs: build-and-deploy
      runs-on: ubuntu-latest
      steps:
        - name: Comment
          uses: peter-evans/create-or-update-comment@v3
          with:
            issue-number: ${{ needs.build-and-deploy.outputs.issueNumber }}
            body: |
                    ## 👀 Deploy
                    The deploy is done with the following command:
                    ${{github.server_url}}/${{ github.repository }}
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            
        - name: Close issue
          uses: peter-evans/close-issue@v2
          with:
            issue-number: ${{ needs.build-and-deploy.outputs.issueNumber }}